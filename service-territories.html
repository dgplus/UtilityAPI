<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Map: Utility API Service Territories | DG+</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,300" rel="stylesheet" type="text/css">
    <link href="css/map-styles.css" rel="stylesheet">
</head>

<body>
    <div id="mapcontainer">
        <div id="map"></div>
        <div class="map-overlay top">
            <div class="map-overlay-inner">
                <h3>Coverage Status</h3>
                <div id="legend"></div>
            </div>
        </div>
        <div id="fullscreen">Full screen</div>
    </div>

    <script>
        const legendDiv = document.getElementById('legend');
        const layerName = 'electric-retail-service-terri-0nv0yj';

        mapboxgl.accessToken =
            'pk.eyJ1IjoiZGdwbHVzZGVzaWduIiwiYSI6ImNsMGhndHJvdjA4aWozZW1xb21tY3VuZGoifQ.R8LGSPakcmmq-FVmRp7_1A';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/dgplusdesign/cle3z3cqz000m01kbnbx79dyj',
            center: {
                lng: -99.48299257741193,
                lat: 40.92230044374887
            },
            zoom: 4.5,
            projection: "mercator"
        });

        map.on('load', () => {
            Promise.all([
                d3.csv(
                    "https://docs.google.com/spreadsheets/d/e/2PACX-1vTpREYfOKz_1Q7BpOQzZRzgJVD16dBRkiCnd-Ri_1NU73mZ47_gsE37H96sD3lVAx0O5Tpywl-7NYAO/pub?gid=410626648&single=true&output=csv"
                    ),
            ]).then(data => {
                const [sprData] = data;
                const colors = {
                    'Yes': '#0048A8',
                    '2024': '#065ED4',
                };

                generateCoverageLegend(colors, legendDiv);

                map.addSource('coverage-source', {
                    type: 'geojson',
                    data: createCoverageGeoJSON(sprData),
                });

                map.addLayer({
                    id: 'coverage-layer',
                    type: 'fill',
                    source: 'coverage-source',
                    paint: {
                        'fill-color': [
                            'match',
                            ['get', 'Coverage'],
                            'Yes', colors['Yes'],
                            '2024', colors['2024'],
                            'transparent',
                        ],
                        'fill-opacity': 0.7,
                        'fill-outline-color': 'white',
                    },
                });

                map.on('mouseenter', 'coverage-layer', (e) => {
                    const feature = e.features[0];
                    if (feature) {
                        const {
                            Entity,
                            Customers,
                            Sales,
                            Coverage
                        } = feature.properties;
                        showPopup(e.lngLat, Entity, Customers, Sales, Coverage);
                    }
                });

                map.on('mouseleave', 'coverage-layer', () => {
                    map.getCanvas().style.cursor = '';
                });
            });
        });

        function createCoverageGeoJSON(data) {
            return {
                type: 'FeatureCollection',
                features: data.map(item => {
                    return {
                        type: 'Feature',
                        properties: {
                            Entity: item.Entity,
                            Customers: item['Customers (Count)'],
                            Sales: item['Sales (Megawatthours)'],
                            Coverage: item['Column J'] === 'Yes' ? 'Yes' : '2024',
                        },
                        geometry: {
                            type: 'Polygon',
                            coordinates: [],
                        },
                    };
                }),
            };
        }

        function showPopup(lngLat, entity, customers, sales, coverage) {
            const popup = new mapboxgl.Popup()
                .setLngLat(lngLat)
                .setHTML(`
                    <div class="popup-main">
                        <div><b>${entity}</b></div>
                        <div>Customers (Count): ${customers}</div>
                        <div>Sales (Megawatthours): ${sales}</div>
                        <div>Coverage: ${coverage}</div>
                    </div>
                `)
                .addTo(map);
        }

        function generateCoverageLegend(colors, legendDiv) {
            Object.entries(colors).forEach(([label, color]) => {
                const div = document.createElement('div');
                div.className = 'square-container-row';

                const text = document.createElement('div');
                text.className = 'square-text';
                text.innerText = label;

                const sq = document.createElement('div');
                sq.className = 'square';
                sq.style.backgroundColor = color;
                sq.style.opacity = 0.7;

                div.appendChild(sq);
                div.appendChild(text);

                legendDiv.appendChild(div);
            });
        }

        const fullscreen = document.getElementById('fullscreen');
        fullscreen.addEventListener('click', toggleFullscreen);

        function toggleFullscreen() {
            const elem = document.getElementById('mapcontainer');
            if (!document.fullscreenElement) {
                elem.requestFullscreen().catch((err) => {
                    alert(`Error attempting to enable fullscreen mode: ${err.message} (${err.name})`);
                });
            } else {
                document.exitFullscreen();
            }
        }
    </script>
</body>

</html>