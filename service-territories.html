<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Map: Utility Data</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,300" rel="stylesheet" type="text/css">
    <!-- <link href="css/map-styles.css" rel="stylesheet"> -->
</head>

<body>
    <div id="mapcontainer">
        <div id="map"></div>
        <div class="map-overlay top">
            <div class="map-overlay-inner">
                <h3>Utility Data</h3>
                <div id="legend"></div>
                <label>Borders: <input id="borders" type="checkbox" checked></label>
            </div>
        </div>
        <div id="fullscreen">Full screen</div>
    </div>

    <script>
        const filtersDiv = document.getElementById('filters');
        const legendDiv = document.getElementById('legend');
        const bordersCheckbox = document.getElementById('borders');
        const layerName = 'electric-retail-service-terri-0nv0yj';
        const mainData = {
            sprData: [],
            filters: new Set()
        }

        mapboxgl.accessToken =
            'pk.eyJ1IjoiZGdwbHVzZGVzaWduIiwiYSI6ImNsMGhndHJvdjA4aWozZW1xb21tY3VuZGoifQ.R8LGSPakcmmq-FVmRp7_1A';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/dgplusdesign/cle3z3cqz000m01kbnbx79dyj',
            center: {
                lng: -99.48299257741193,
                lat: 40.92230044374887
            },
            zoom: 4.5,
            projection: "mercator"
        });

        map.on('load', () => {
            Promise.all([
                d3.csv(
                    "https://docs.google.com/spreadsheets/d/e/2PACX-1vT_zsl_ENEGp078oZ2dU2wBZTsIccGvHaK75GIM_yNQ_jS421uQe3s-0vOy6ekJnCQPx-yMlI3W3Zdh/pub?gid=410626648&single=true&output=csv"
                    ),
            ]).then(data => {
                const [sprData] = data;
                mainData.sprData.push(...sprData);

                // Create legend and filters
                generateLegend(legendDiv);

                // Create a filter for "Yes" and "2024" values in Column J
                buildUtilityFilters(sprData);

                // Set up map styling based on Column J
                map.setPaintProperty(layerName, "fill-color", [
                    'match',
                    ['get', 'Column J'],
                    'Yes', '#0048A8',
                    '2024', '#065ED4',
                    '#ccc' // Default color
                ]);

                // Handle click events to show popups
                map.on("click", layerName, e => {
                    const features = map.queryRenderedFeatures(e.point);
                    if (features.length > 0) {
                        const feature = features[0];
                        showPopup(feature.properties);
                    }
                });

                // Set up cursor change on hover
                map.on('mouseenter', layerName, () => {
                    map.getCanvas().style.cursor = 'pointer';
                });

                map.on('mouseleave', layerName, () => {
                    map.getCanvas().style.cursor = '';
                });

                // Toggle border visibility
                bordersCheckbox.addEventListener('input', () => {
                    const val = bordersCheckbox.checked ? "white" : "transparent"
                    map.setPaintProperty(layerName, "fill-outline-color", val)
                });
            });
        });

        function generateLegend(legendDiv) {
            // Create a legend with colors and labels
            const legendData = [{
                    color: '#0048A8',
                    label: 'Yes'
                },
                {
                    color: '#065ED4',
                    label: '2024'
                }
            ];

            const legend = document.createElement("div");
            legend.className = "legend-container";

            legendData.forEach(item => {
                const legendItem = document.createElement("div");
                legendItem.className = "legend-item";

                const colorBox = document.createElement("div");
                colorBox.className = "legend-color-box";
                colorBox.style.backgroundColor = item.color;

                const label = document.createElement("div");
                label.className = "legend-label";
                label.textContent = item.label;

                legendItem.appendChild(colorBox);
                legendItem.appendChild(label);
                legend.appendChild(legendItem);
            });

            legendDiv.appendChild(legend);
        }

        function buildUtilityFilters(data) {
            const uniqueValues = [...new Set(data.map(d => d['Column J']))];

            uniqueValues.forEach(value => {
                const div = document.createElement("div");
                div.className = "checkbox-container";

                const input = document.createElement("input");
                input.type = "checkbox";
                input.className = "checkbox";
                input.id = value;
                input.addEventListener('input', () => {
                    toggleUtilityFilter(value);
                });

                const label = document.createElement("label");
                label.htmlFor = value;
                label.innerText = value;

                div.appendChild(input);
                div.appendChild(label);
                filtersDiv.appendChild(div);
            });
        }

        function toggleUtilityFilter(value) {
            if (mainData.filters.has(value)) {
                mainData.filters.delete(value);
            } else {
                mainData.filters.add(value);
            }

            map.setFilter(layerName, ['in', 'Column J', ...mainData.filters]);
        }

        function showPopup(properties) {
            const popupContent = `
                <div class="popup-main">
                    <div><b>${properties['Column A']}</b></div>
                    <div>Column D: ${properties['Column D']}</div>
                    <div>Column E: ${properties['Column E']}</div>
                    <div>Column J: ${properties['Column J']}</div>
                    <div>Column P: ${properties['Column P']}</div>
                    <div>Column Q: ${properties['Column Q']}</div>
                </div>
            `;

            new mapboxgl.Popup()
                .setHTML(popupContent)
                .addTo(map);
        }

        const fullscreen = document.getElementById('fullscreen');
        fullscreen.addEventListener('click', toggleFullscreen);

        function toggleFullscreen()